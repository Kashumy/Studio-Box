<!doctype html>
<html lang="pl" ondblclick="document.documentElement.requestFullscreen();">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waveform Grid Player</title>
<style>
body{margin:0;font-family:system-ui;background:#0e0e0e;color:#fff}
.top{padding:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:#151515;border-bottom:1px solid #222}
.block{display:flex;flex-direction:column;font-size:13px;gap:6px}
.block input[type=color],.block input[type=file]{padding:6px;background:#000;border:1px solid #333;color:#fff}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:9px 14px;background:#222;border:1px solid #444;color:#fff;font-size:13px;cursor:pointer}
.btn:hover{background:#2a2a2a}
#grid{display:grid;gap:10px;padding:18px}
canvas{width:100%;height:140px;background:#000;display:block}
#playerContainer{
  position:fixed;
  top:0; left:0; width:100vw; height:100vh;
  background:#000;
  opacity:0;
  pointer-events:none;
  z-index:9999;
}
#playerCanvas{
  width:100%; height:100%;
  display:block;
}

.file-label {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.file-label input[type="file"] {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  opacity: 0;
}
input[type="number"] {
	content: "Choose File(s)";
padding: 9px 14px;
background: #222;
border: 1px solid #444;
color: #fff;
font-size: 13px;
white-space: nowrap;
transition: background 0.2s; border:none; outline:none;
}
.file-label::after {
  content: "Choose File(s)";
  padding: 9px 14px;
  background: #222;
  border: 1px solid #444;
  color: #fff;
  font-size: 13px;
  white-space: nowrap;
  transition: background 0.2s;
}

.file-label:hover::after {
  background: #2a2a2a;
}


</style>
</head>
<body>
	<script src="./jszip.min.js"></script>
<div id="editor">
  <div class="top">
<div class="block">
  <label class="file-label">
    Audio File/Files or Zip
    <input id="file" type="file" accept="audio/*,.zip" multiple>
  </label>
</div>

    <div class="controls">
      <button id="add" class="btn">Add waveform/s if zip</button>
      <button id="clear" class="btn">Clear</button>
    </div>
    <div class="block"><label>Bg<input id="bg" type="color" value="#000000"></label></div>
    <div class="block"><label>Waveform<input id="wave" type="color" value="#00ff99"></label></div>
    <div class="block" style="display:none;"><label>PANNING<input id="panColor" type="color" value="#ff3355"></label></div>
    <div class="block" style="display:none;"><label>Show Panning<input id="showPan" type="checkbox"></label></div>
    <div class="block">
  <label>Stroke Size
    <input id="strokeSize" type="number" min="1" max="10" value="1" style="width:60px">
  </label>
</div>

    <div style="margin-left:auto;display:flex;gap:8px"><button id="play" class="btn">Play In Player</button></div>
  </div>
  <div id="grid"></div>
</div>

<div id="playerContainer">
  <canvas id="playerCanvas"></canvas>
</div>

<script>
const FILE=document.getElementById('file');
const ADD=document.getElementById('add');
const CLEAR=document.getElementById('clear');
const BG=document.getElementById('bg');
const WAV=document.getElementById('wave');
const PAN=document.getElementById('panColor');
const SHOW=document.getElementById('showPan');
const PLAY=document.getElementById('play');
const GRID=document.getElementById('grid');
const PLAYER=document.getElementById('playerContainer');
const PLAYER_CANVAS=document.getElementById('playerCanvas');
const STROKE_SIZE = document.getElementById('strokeSize');

const EDITOR=document.getElementById('editor');

let listFiles=[], buffers=[], filenames=[];
let ac, sources=[], analyzers=[];
const PADDING = 2; 
[BG, WAV, PAN, SHOW].forEach(el => {
    el.oninput = () => renderGrid();
});

ADD.onclick = async () => {
	if (!FILE.files.length) return;
	
	for (let f of FILE.files) {
		if (f.name.endsWith('.zip')) {
			const zip = new JSZip();
			const content = await zip.loadAsync(f); 
			
			for (let filename of Object.keys(content.files)) {
				const entry = content.files[filename];
				if (entry.dir) continue; 
				if (!filename.match(/\.(mp3|wav|ogg)$/i)) continue;
				
				const blob = await entry.async('blob'); 
				const ab = await blob.arrayBuffer();
				await addBuffer(filename, ab);
			}
		} else {
			const ab = await f.arrayBuffer();
			await addBuffer(f.name, ab);
		}
	}
	
	renderGrid();
};

async function addBuffer(name, arrayBuffer) {
	const actx = new(window.AudioContext || window.webkitAudioContext)();
	const buf = await actx.decodeAudioData(arrayBuffer);
	buffers.push(buf);
	filenames.push(name);
	listFiles.push(name); 
	actx.close();
}
CLEAR.onclick=()=>{listFiles=[]; buffers=[]; filenames=[]; GRID.innerHTML='';}

function renderGrid(){
  GRID.innerHTML='';
  const n=buffers.length;
  const cols=Math.ceil(Math.sqrt(n));
  GRID.style.gridTemplateColumns=`repeat(${cols},1fr)`;
  buffers.forEach(buf=>{
    const c=document.createElement('canvas');
    GRID.appendChild(c);
    drawBuffer(buf,c);
  });
}

function drawBuffer(buf,c){
  const ctx=c.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  c.width=c.clientWidth*dpr;
  c.height=c.clientHeight*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  const w=c.clientWidth,h=c.clientHeight;
  const L=buf.getChannelData(0);
  const R=buf.numberOfChannels>1?buf.getChannelData(1):null;
  ctx.fillStyle=BG.value;
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle=WAV.value;
  ctx.beginPath();
  const step=Math.ceil(L.length/w);
  for(let x=0;x<w;x++){
    let sl=0,sr=0;
    for(let j=0;j<step;j++){
      sl+=Math.abs(L[x*step+j]||0);
      if(R) sr+=Math.abs(R[x*step+j]||0);
    }
    const yL=(sl/step)*h;
    ctx.moveTo(x,h/2-yL/2);
    ctx.lineTo(x,h/2+yL/2);
    if(R && SHOW.checked){
      const yR=(sr/step)*h;
      ctx.strokeStyle=PAN.value;
      ctx.moveTo(x,h/2-yR/2);
      ctx.lineTo(x,h/2+yR/2);
      ctx.stroke();
      ctx.strokeStyle=WAV.value;
    }
  }
  ctx.stroke();
}
async function startPlayer(){
  ac=new (window.AudioContext||window.webkitAudioContext)();
  sources=[]; analyzers=[];
  const cvs=PLAYER_CANVAS;
  const ctx=cvs.getContext('2d');
  cvs.width=window.innerWidth;
  cvs.height=window.innerHeight;

  buffers.forEach((buf,i)=>{
    const src=ac.createBufferSource();
    src.buffer=buf;
    const an=ac.createAnalyser();
    an.fftSize=1024;
    src.connect(an);
    an.connect(ac.destination);
    sources.push(src);
    analyzers.push({an,L:buf.getChannelData(0),R:buf.numberOfChannels>1?buf.getChannelData(1):null, name: filenames[i]});
    src.start();
  });

  visualizePlayer();
}
PLAY.onclick = async () => {
    if (!listFiles.length) return;
    ac = new (window.AudioContext || window.webkitAudioContext)();
    await ac.resume();
    PLAYER.style.opacity='1';
    PLAYER.style.pointerEvents='auto';
    EDITOR.style.opacity='0';
    EDITOR.style.pointerEvents='none';
    history.pushState({player:true},"","");
    setTimeout(startPlayer,1000)
};
 



function visualizePlayer(){
  requestAnimationFrame(visualizePlayer);
  const ctx=PLAYER_CANVAS.getContext('2d');
  const w=PLAYER_CANVAS.width;
  const h=PLAYER_CANVAS.height;
  const n=analyzers.length;
  const cols=Math.ceil(Math.sqrt(n));
  const rows=Math.ceil(n/cols);
  const cellW=(w-(cols+1)*PADDING)/cols;
  const cellH=(h-(rows+1)*PADDING)/rows;

  ctx.fillStyle=BG.value;
  ctx.fillRect(0,0,w,h);

  analyzers.forEach((a,i)=>{
    const col=i%cols;
    const row=Math.floor(i/cols);
    const x=PADDING + col*(cellW+PADDING);
    const y=PADDING + row*(cellH+PADDING);
    ctx.strokeStyle=WAV.value;
    ctx.lineWidth = parseFloat(STROKE_SIZE.value) || 1;
    ctx.beginPath();
    const dataL=new Uint8Array(a.an.fftSize);
    a.an.getByteTimeDomainData(dataL);
    let px=0;
    const sliceX=cellW/dataL.length;
    for(let j=0;j<dataL.length;j++){
      const v=(dataL[j]-128)/128;
      const py=y+cellH/2 - v*cellH/2;
      if(j===0) ctx.moveTo(x+px,py); else ctx.lineTo(x+px,py);
      px+=sliceX;
    }
    ctx.stroke();
    if(SHOW.checked && a.R){
      ctx.strokeStyle=PAN.value;
      ctx.beginPath();
      px=0;
      for(let j=0;j<a.R.length;j++){
        const py=y+cellH/2 - a.R[j]*cellH/2;
        if(j===0) ctx.moveTo(x+px,py); else ctx.lineTo(x+px,py);
        px+=sliceX;
      }
      ctx.stroke();
    }
const displayName = a.name.replace(/\.[^/.]+$/, ""); 
ctx.fillStyle="#fff";
ctx.font="12px sans-serif";
ctx.textAlign="center";
ctx.fillText(displayName, x+cellW/2, y+16);

  });
}
window.addEventListener('resize',()=>{
  PLAYER_CANVAS.width=window.innerWidth;
  PLAYER_CANVAS.height=window.innerHeight;
});
window.addEventListener('popstate',()=>{
  if(sources.length){
    sources.forEach(s=>{try{s.stop()}catch(e){}});
    sources=[];
    analyzers=[];
    if(ac) ac.close();
  }
  PLAYER.style.opacity='0';
  PLAYER.style.pointerEvents='none';
  EDITOR.style.opacity='1';
  EDITOR.style.pointerEvents='auto';
  if(document.exitFullscreen) document.exitFullscreen();
});
</script>
</body>
</html>
