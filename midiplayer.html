<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MIDI Visualizer</title>
<style>
html,body{margin:0;height:100%;background:#1E2F2E;color:#fff;overflow:hidden}
canvas{display:block;width:100%;height:100%}
</style>
</head>
<body>
<canvas id="vis"></canvas>
<canvas id="piano" onclick="document.documentElement.requestFullscreen()" style="position:fixed;bottom:0;left:0;width:100%;height:100px"></canvas>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.11.0/dist/jszip.min.js"></script>

<script>
//879A8F
const audioCtx=new(window.AudioContext||window.webkitAudioContext)()
let ticksPerQuarter=480,events=[],visualNotes=[],playing=false,startTime=0,sources=[]
const LOWEST=0,KEYS=88+64,pianoHeight=20
const vis=document.getElementById('vis'),ctx=vis.getContext('2d')
const piano=document.getElementById('piano'),pctx=piano.getContext('2d')
const colors=[...Array(128)].map((_,i)=>`hsl(${i*137.5%360} 70% 55%)`)
function noteFreq(n){return 440*Math.pow(2,(n-69)/12)}
function playNoteAt(time,note,vel,dur,instrument='chipwave'){
  const g=audioCtx.createGain()
  g.gain.setValueAtTime(vel/127,time)
  g.gain.exponentialRampToValueAtTime(0.001,time+dur)
  g.connect(audioCtx.destination); let o;
  if(instrument==='drums'){
  const bufferSize=audioCtx.sampleRate*dur
  const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate)
  const data=buffer.getChannelData(0)
  for(let i=0;i<bufferSize;i++)data[i]=Math.random()*2-1
  o=audioCtx.createBufferSource()
  o.buffer=buffer
  let freq=8000,q=1,filterType='bandpass',decay=dur*0.8
  if(note<=36){freq=80;filterType='lowpass';decay=0.5}
  else if(note<=38){freq=1500;q=0.8;filterType='bandpass'}
  else if(note<=40){freq=1000;q=1.5;filterType='bandpass'}
  else if(note<=42){freq=7000;q=4;filterType='highpass';decay=0.2}
  else if(note<=44){freq=6000;q=3;filterType='bandpass';decay=0.3}
  else if(note<=46){freq=9000;q=2;filterType='highpass';decay=0.4}
  else if(note<=48){freq=800;q=1.8;filterType='bandpass'}
  else if(note<=50){freq=1200;q=2;filterType='bandpass'}
  else if(note<=55){freq=4000;q=1.5;filterType='bandpass'}
  else if(note<=57){freq=6000;q=1.2;filterType='bandpass'}
  else if(note<=59){freq=900;q=1.2;filterType='bandpass'}
  else {freq=11000;q=6;filterType='highpass';decay=0.25}
  const filter=audioCtx.createBiquadFilter()
  filter.type=filterType
  filter.frequency.value=freq
  filter.Q.value=q
  const env=audioCtx.createGain()
  env.gain.setValueAtTime(vel/127,time)
  env.gain.exponentialRampToValueAtTime(0.001,time+decay)
  o.connect(filter)
  filter.connect(env)
  env.connect(audioCtx.destination)
  o.start(time)
  o.stop(time+decay)
  sources.push(o)
  o.onended=()=>sources=sources.filter(s=>s!==o)
  return
}
else{
o = audioCtx.createOscillator()
if(instrument==='piano') {g.gain.setValueAtTime(0.001, time)
g.gain.linearRampToValueAtTime(vel / 127, time + 0.01)
g.gain.exponentialRampToValueAtTime(0.001, time + dur)
g.connect(audioCtx.destination)
const real = new Float32Array([1, 1, 0.5, 0, 0.5])
const imag = new Float32Array(real.length)
const wave = audioCtx.createPeriodicWave(real, imag)
o.setPeriodicWave(wave)
}
else if(instrument==='guitar'){
  const real=new Float32Array([0,1,0.5,1])
  const imag=new Float32Array(real.length)
  const wave=audioCtx.createPeriodicWave(real,imag)
  o.setPeriodicWave(wave)
}
else if(instrument==='harmonics') o.type='square'
else if(instrument==='chipwave') o.type='sawtooth'
else o.type='sawtooth'

// o.type='square'

 


o.frequency.value=noteFreq(note)

  }
  o.connect(g)
  o.start(time)
  o.stop(time+dur)
  sources.push(o)
  o.onended=()=>sources=sources.filter(s=>s!==o)
}

function stopAudio(){for(const s of sources){try{s.stop()}catch{}}sources=[]}
function keyX(key) {
  const black=[1,3,6,8,10], white=[]
  for(let i=0,m=LOWEST;i<KEYS;i++,m++) if(!black.includes(m%12)) white.push(m)
  const whiteW=piano.width/white.length
  if(!black.includes(key%12)) return white.indexOf(key)*whiteW
  const idx=white.findIndex(k=>k>key)-1; const wx=idx*whiteW+whiteW*0.7
  return wx
}

function readStr(v,p,l){let s='';for(let i=0;i<l;i++)s+=String.fromCharCode(v.getUint8(p+i));return s}
function varLen(v,p){let val=0;while(true){let b=v.getUint8(p++);val=(val<<7)|(b&0x7f);if(!(b&0x80))break}return{v:val,p}}
function parseMIDI(buf){
  const v=new DataView(buf)
  if(readStr(v,0,4)!=='MThd')throw'Invalid MIDI'
  const ntr=v.getUint16(10),div=v.getUint16(12)
  ticksPerQuarter=div
  let pos=14,all=[]
  for(let t=0;t<ntr;t++){
    if(readStr(v,pos,4)!=='MTrk')throw'No track'; pos+=4
    let len=v.getUint32(pos); pos+=4
    const end=pos+len, ev=[], prog=Array(16).fill(0)
    let tick=0, run=null
    while(pos<end){
      const d=varLen(v,pos); tick+=d.v; pos=d.p
      let s=v.getUint8(pos++)
      if(s<0x80){s=run; pos--}else run=s
      if(s===0xff){
        const meta=v.getUint8(pos++), l=varLen(v,pos); pos=l.p
        if(meta===0x51 && l.v===3){
          const tempo=(v.getUint8(pos)<<16)|(v.getUint8(pos+1)<<8)|v.getUint8(pos+2)
          ev.push({type:'tempo',tick,tempo})
        }
        pos += l.v
        continue
      }
      const type=s&0xf0, ch=s&0x0f
      if(type===0xc0){prog[ch]=v.getUint8(pos++); continue}
      if(type===0x90 || type===0x80){
        const key=v.getUint8(pos++), vel=v.getUint8(pos++)
        ev.push({type:type===0x90 && vel>0?'noteOn':'noteOff', tick, key, vel, ch, prog:prog[ch]})
      } else if(type===0xa0||type===0xb0||type===0xe0) pos+=2
      else if(type===0xd0) pos+=1
    }
    all.push(ev)
    pos=end
  }

  const merged=[].concat(...all).sort((a,b)=>a.tick-b.tick)
  let tempo=500000, lastTick=0, sec=0, active=[], notes=[]
  for(const e of merged){
    const dt=e.tick-lastTick
    if(e.type==='tempo') tempo=e.tempo
    sec += dt*(tempo/ticksPerQuarter)/1e6
    lastTick = e.tick
    if(e.type==='noteOn') active.push({...e, start:sec})
    if(e.type==='noteOff'){
      const on=active.find(n=>n.key===e.key && n.ch===e.ch && n.end===undefined)
      if(on){ on.end=sec; notes.push({...on}) }
    }
  }
  events=notes
}

function resize(){
vis.width=innerWidth*devicePixelRatio
vis.height=innerHeight*devicePixelRatio
piano.width=innerWidth*devicePixelRatio
piano.height=pianoHeight*devicePixelRatio
drawPiano()
}
window.addEventListener('resize',resize)
function drawPiano(){
const w=piano.width,h=piano.height
pctx.clearRect(0,0,w,h)
const black=[1,3,6,8,10],white=[];for(let i=0,m=LOWEST;i<KEYS;i++,m++)if(!black.includes(m%12))white.push(m)
const whiteW=w/white.length,blackH=pianoHeight*0.6, whiteHeight=pianoHeight;
let x=0
for(const m of white){pctx.strokeStyle='rgba(0,0,0,0.25)';  pctx.strokeRect(x,h-whiteHeight,whiteW,whiteHeight); pctx.fillStyle='#f2f2f2';pctx.fillRect(x,h-whiteHeight,whiteW,whiteHeight);pctx.strokeStyle='rgba(0,0,0,0.25)';  pctx.strokeRect(x,h-whiteHeight+20,whiteW,whiteHeight); x+=whiteW}
for(let i=0,m=LOWEST;i<KEYS;i++,m++)if(black.includes(m%12)){let idx=white.findIndex(k=>k>m)-1;if(idx<0)idx=white.length-1
const wx=idx*whiteW+whiteW*0.7;pctx.fillStyle='#111';pctx.fillRect(wx,h-blackH/0.6,whiteW*0.6,blackH)}
}
function schedule() { visualNotes = events.map(n => ({ ...n, played: false })) }
function play(){
  if(!events.length) return
  setTimeout(()=>{
  schedule()
  startTime = audioCtx.currentTime
  playing = true
  requestAnimationFrame(draw) 
  requestAnimationFrame(playScheduledNotes) 
  },6000);
}
function playScheduledNotes(){
  const now = audioCtx.currentTime
  for(const n of visualNotes){
    if(!n.played && startTime + n.start <= now + 0.1){
      const t = startTime + n.start
      
let instrument='chipwave'
if(n.ch===9)instrument='drums'
else if(n.prog>=0&&n.prog<=7)instrument='piano'
else if(n.prog>=24&&n.prog<=31)instrument='guitar'
else if(n.prog>=80&&n.prog<=87)instrument='harmonics'
playNoteAt(t,n.key,n.vel,n.end-n.start,instrument)

      n.played = true
    }
  }
  if(playing) requestAnimationFrame(playScheduledNotes)
}
function stop(){playing=false;stopAudio()}
function draw(){
  if(!playing)return
  const w=vis.width,h=vis.height,pw=pianoHeight*devicePixelRatio
  ctx.clearRect(0,0,w,h)
  const now=audioCtx.currentTime-startTime,pTop=h-pw
  const black=[1,3,6,8,10],white=[]
  for(let i=0,m=LOWEST;i<KEYS;i++,m++) if(!black.includes(m%12)) white.push(m)
  const whiteW=w/white.length, blackH=pw*0.6
  for(const n of visualNotes){
    if(n.end<now) continue
    const noteH=(n.end-n.start)*300-5
    const x = keyX(n.key)
    const wKey = black.includes(n.key%12)?whiteW*0.6:whiteW
    const y = pTop-(n.start-now)*300-noteH
    let prog = n.prog ?? 0
let c = colors[prog % colors.length]
if (n.ch === 9) {
	c = 'hsl(0 0% 50%)'
}else{
if(black.includes(n.key % 12)){
  const m = c.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/)
  if(m){
    let [h,s,l] = m.slice(1).map(Number)
    l = Math.max(0,l-15)
    c = `hsl(${h} ${s}% ${l}%)`
  }
}
}
    ctx.fillStyle=c
    ctx.fillRect(x,y,wKey,noteH)
  }
  drawPianoHighlight(now)
  requestAnimationFrame(draw)
}


function drawPianoHighlight(t){
const w=piano.width,h=piano.height,white=[]
pctx.clearRect(0,0,w,h)
for(let i=0,m=LOWEST;i<KEYS;i++,m++)if(![1,3,6,8,10].includes(m%12))white.push(m)
const whiteW=w/white.length,blackH=pianoHeight*0.6, whiteHeight=pianoHeight;
let x=0
  
for(const m of white){let on=visualNotes.some(v=>t>=v.start&&t<=v.end&&v.key===m)
pctx.strokeStyle='rgba(0,0,0,0.25)';  pctx.strokeRect(x,h-whiteHeight,whiteW,whiteHeight);
pctx.fillStyle=on?'#ffd580':'#f2f2f2';pctx.fillRect(x,h-whiteHeight,whiteW,whiteHeight)
pctx.strokeStyle='rgba(0,0,0,0.25)';pctx.strokeRect(x,h-whiteHeight+20,whiteW,whiteHeight); x+=whiteW}

for(let m=LOWEST;m<LOWEST+KEYS;m++)if([1,3,6,8,10].includes(m%12)){
let idx=white.findIndex(k=>k>m)-1;if(idx<0)idx=white.length-1
const wx=idx*whiteW+whiteW*0.7
let on=visualNotes.some(v=>t>=v.start&&t<=v.end&&v.key===m)
pctx.fillStyle=on?'#ffb84d':'#111'
pctx.fillRect(wx,h-blackH/0.6,whiteW*0.6,blackH)
}
}
vis.addEventListener('click',()=>{
const i=document.createElement('input')
i.type='file';i.accept='.mid'
i.onchange=e=>{
const f=e.target.files[0];if(!f)return
const r=new FileReader()
r.onload=v=>{try{parseMIDI(v.target.result);stop();play()}catch{alert('Błąd pliku MIDI')}}
r.readAsArrayBuffer(f)
}
i.click()
})
resize()
</script>
</body>
</html>
